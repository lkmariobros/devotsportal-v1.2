# Database Integration: Drizzle ORM with Supabase

This project uses Drizzle ORM for database schema definition and migrations, with Supabase PostgreSQL as the database provider.

## Setup

1. Copy `.env.example` to `.env` and fill in your Supabase credentials:

```
SUPABASE_URL=https://your-project-id.supabase.co
SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_KEY=your-service-key
SUPABASE_POSTGRES_URL=postgresql://postgres:your-password@db.your-project-id.supabase.co:5432/postgres
```

2. Install dependencies:

```bash
pnpm install
```

## Working with the Database

### Inspecting Existing Schema

If you already have tables in Supabase and want to see what's there:

```bash
pnpm db:inspect
```

### Generating Drizzle Schema from Existing Database

To generate Drizzle schema files from your existing Supabase database:

```bash
pnpm db:introspect
```

This will create TypeScript files in `src/db/schema` based on your existing tables.

### Modifying Schema

Edit the schema files in `src/db/schema/` to make changes to your database structure.

### Generating Migrations

After modifying your schema, generate migrations:

```bash
pnpm db:generate
```

This creates SQL migration files in `src/db/migrations/`.

### Running Migrations

To apply migrations to your Supabase database:

```bash
pnpm db:run-migrations
```

### Using Drizzle Studio

To visually explore and modify your database:

```bash
pnpm db:studio
```

## Database Access Patterns

### Using Drizzle for Queries

```typescript
import { db } from '@/db';
import { todo } from '@/db/schema/todo';
import { eq } from 'drizzle-orm';

// Query todos
const todos = await db.select().from(todo).where(eq(todo.userId, userId));

// Insert a todo
const newTodo = await db.insert(todo).values({
  text: 'New todo',
  userId
}).returning();

// Update a todo
await db.update(todo)
  .set({ completed: true })
  .where(eq(todo.id, todoId));

// Delete a todo
await db.delete(todo).where(eq(todo.id, todoId));
```

### Using Supabase for Real-time Features

```typescript
import { createRealtimeSubscription } from '@/db/utils';

// Subscribe to changes
const subscription = createRealtimeSubscription<Todo>(
  'todo',
  `user_id=eq.${userId}`,
  (newTodo) => {
    console.log('Todo updated:', newTodo);
    // Update UI or state
  }
);

// Unsubscribe when done
subscription.unsubscribe();
```

## Best Practices

1. **Schema Management**: Define all schemas in Drizzle and use its migration tools.
2. **Row-Level Security**: Define RLS policies in Supabase for security.
3. **Real-time Features**: Use Supabase for real-time subscriptions.
4. **File Storage**: Use Supabase Storage for file uploads and management.
5. **Authentication**: Use Better Auth with Drizzle adapter for authentication.

## Troubleshooting

- **Connection Issues**: Ensure your Supabase connection string is correct and includes the correct password.
- **Migration Failures**: Check the SQL generated by Drizzle before applying migrations.
- **Schema Conflicts**: If you modify the schema in Supabase directly, run `pnpm db:introspect` to update your Drizzle schema files.
